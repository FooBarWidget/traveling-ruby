# Reducing the size of your Traveling Ruby packages

Packages generated by Traveling Ruby can be large, but you can reduce the size of your packages by many megabytes by removing unnecessary files.

## Typically removable files

You can typically safely remove the following files:


    # Remove tests
    rm -rf lib/vendor/ruby/*/gems/*/test
    rm -rf lib/vendor/ruby/*/gems/*/tests
    rm -rf lib/vendor/ruby/*/gems/*/spec
    rm -rf lib/vendor/ruby/*/gems/*/features
    rm -rf lib/vendor/ruby/*/gems/*/benchmark

    # Remove documentation
    rm -f lib/vendor/ruby/*/gems/*/README*
    rm -f lib/vendor/ruby/*/gems/*/CHANGE*
    rm -f lib/vendor/ruby/*/gems/*/Change*
    rm -f lib/vendor/ruby/*/gems/*/COPYING*
    rm -f lib/vendor/ruby/*/gems/*/LICENSE*
    rm -f lib/vendor/ruby/*/gems/*/MIT-LICENSE*
    rm -f lib/vendor/ruby/*/gems/*/TODO
    rm -f lib/vendor/ruby/*/gems/*/*.txt
    rm -f lib/vendor/ruby/*/gems/*/*.md
    rm -f lib/vendor/ruby/*/gems/*/*.rdoc
    rm -rf lib/vendor/ruby/*/gems/*/doc
    rm -rf lib/vendor/ruby/*/gems/*/docs
    rm -rf lib/vendor/ruby/*/gems/*/example
    rm -rf lib/vendor/ruby/*/gems/*/examples
    rm -rf lib/vendor/ruby/*/gems/*/sample
    rm -rf lib/vendor/ruby/*/gems/*/doc-api
    find lib/vendor/ruby -name '*.md' | xargs rm -f

    # Remove misc unnecessary files
    rm -rf lib/vendor/ruby/*/gems/*/.gitignore
    rm -rf lib/vendor/ruby/*/gems/*/.travis.yml

    # Remove leftover native extension sources and compilation objects
    rm -f lib/vendor/ruby/*/gems/*/ext/Makefile
    rm -f lib/vendor/ruby/*/gems/*/ext/*/Makefile
    rm -f lib/vendor/ruby/*/gems/*/ext/*/tmp
    find lib/vendor/ruby -name '*.c' | xargs rm -f
    find lib/vendor/ruby -name '*.cpp' | xargs rm -f
    find lib/vendor/ruby -name '*.h' | xargs rm -f
    find lib/vendor/ruby -name '*.rl' | xargs rm -f
    find lib/vendor/ruby -name 'extconf.rb' | xargs rm -f
    find lib/vendor/ruby/*/gems -name '*.o' | xargs rm -f
    find lib/vendor/ruby/*/gems -name '*.so' | xargs rm -f
    find lib/vendor/ruby/*/gems -name '*.bundle' | xargs rm -f

    # Remove Java files. They're only used for JRuby support
    find lib/vendor/ruby -name '*.java' | xargs rm -f
    find lib/vendor/ruby -name '*.class' | xargs rm -f

## Removing gem-specific files

Depending on which gems you use, there may be more files that you can remove.

What I typically do is to run `find lib/vendor/ruby/*/gems | less` to inspect which files exist, and try to identify the files that I think can be removed.

To focus on non-Ruby files, I run `find lib/vendor/ruby/*/gems -type f | grep -v '.rb$' | less` which filters out all .rb files.

Here are a few examples:

 * Many gems that contain a Rakefile only need those Rakefiles for the purpose of developing those gems. In many cases, you can safely remove those Rakefiles without impacting your application. In a similar fashion, the `task` directory within those gems (which typically contain further Rake tasks) can also be removed.
 * The `nokogori` gem contains the `suppressions` directory. This directory contains Valgrind suppression files, so if you never use Valgrind (which is very likely) then you can remove that directory too.
 * The `nokogori` gem also contains the `ports` directory. This directory is only used during compilation of the native extension, so it can be removed.
 * The `rack` gem contains a `contrib` directory which appears to be only relevant for documentation purposes, so it too can be removed.
 * The `rugged` gem contains a `vendor` directory which contains the libgit2 source code, but this directory is only used during compilation of the native extension, so it can be safely removed.

When in doubt, you should inspect the gem's source code to check how a file is used and whether you can remove it.

## Removing seldomly used encodings

Ruby support many encodings that are seldomly used. Most applications only use ASCII and UTF-8. But Ruby also supports UTF-16, UTF-32, various Chinese, Japanese and Korean encodings, etc. Usually you can get rid of everything besides ASCII and UTF-8:

    rm -f lib/ruby/lib/ruby/*/*/enc/cp949*
    rm -f lib/ruby/lib/ruby/*/*/enc/euc_*
    rm -f lib/ruby/lib/ruby/*/*/enc/shift_jis*
    rm -f lib/ruby/lib/ruby/*/*/enc/koi8_*
    rm -f lib/ruby/lib/ruby/*/*/enc/emacs*
    rm -f lib/ruby/lib/ruby/*/*/enc/gb*
    rm -f lib/ruby/lib/ruby/*/*/enc/big5*
    rm -f lib/ruby/lib/ruby/*/*/enc/windows*
    rm -f lib/ruby/lib/ruby/*/*/enc/utf_16*
    rm -f lib/ruby/lib/ruby/*/*/enc/utf_32*

Very few applications need support for transcoding strings from one encoding to another, besides ASCII and UTF-8. You can get rid of transcoding support as follows:

    rm -rf lib/ruby/lib/ruby/*/*/enc/trans

## Removing RDoc

Most likely your application does not need RDoc during runtime. You can remove that as follows:

    rm -rf lib/ruby/lib/ruby/*/rdoc*




# Reducing the size of your Traveling Ruby packages

Before

```console
du -sh * | sort -nr                
384M    runtime
224M    output
 36K    internal
 28K    setup-runtime.sh
 16K    build-ruby.sh
8.0K    Rakefile
4.0K    test-gems.sh
4.0K    package.sh
4.0K    README.md
```

After

```console
du -sh * | sort -nr
384M    runtime
 67M    output
 36K    internal
 28K    setup-runtime.sh
 16K    build-ruby.sh
 15M    traveling-ruby-gems-20230601-3.0.6-osx-x86_64
8.0K    Rakefile
6.8M    traveling-ruby-20230601-3.0.6-osx-x86_64.tar.gz
4.0K    test-gems.sh
4.0K    package.sh
4.0K    README.md
```

export BUILD_OUTPUT_DIR=output/3.0.6-x86_64/

# Remove tests
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/test| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/tests| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/spec| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/features| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/benchmark| xargs rm -rf

# Remove documentation
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/README*| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/CHANGE*| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/Change*| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/COPYING*| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/LICENSE*| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/MIT-LICENSE*| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/TODO| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/*.txt| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/*.md| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/*.rdoc| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/doc| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/docs| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/example| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/examples| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/sample| xargs rm -rf
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/doc-api| xargs rm -rf

find ${BUILD_OUTPUT_DIR}**/.md| xargs rm -rf
find ${BUILD_OUTPUT_DIR}**/.gitignore| xargs rm -rf
find ${BUILD_OUTPUT_DIR}**/.github| xargs rm -rf
find ${BUILD_OUTPUT_DIR} -name '.travis.yml'| xargs rm -rf

# Remove leftover native extension sources and compilation objects
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/ext/Makefile| xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/ext/*/Makefile| xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/ext/*/tmp| xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ -name '*.c' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ -name '*.cpp' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ -name '*.h' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ -name '*.rl' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ -name 'extconf.rb' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems -name '*.o' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems -name '*.so'| xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/lib/*/3.*/ -not -path '3.0' -name '*.bundle' | xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/rdoc*| xargs rm -f ## Removing RDoc
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/trans/*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/cp949*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/euc_*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/shift_jis*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/koi8_*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/emacs*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/gb*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/big5*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/windows*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/utf_16*| xargs rm -f
ls ${BUILD_OUTPUT_DIR}lib/ruby/*/*/enc/utf_32*| xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/vendor -type f | grep -v '.rb$' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/curses*/vendor -type f | grep -v '.rb$' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/rugged*/vendor -type f | grep -v '.rb$' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib/ruby/gems/3.0.0/gems/*/contrib -type f | grep -v '.rb$' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib -type f -name '*.java' | xargs rm -f
find ${BUILD_OUTPUT_DIR}lib -type f -name '*.class'| xargs rm -f


# safe

 33M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/charlock_holmes-0.7.7/lib/charlock_holmes/charlock_holmes.bundle
 33M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/charlock_holmes-0.7.7/ext/charlock_holmes/charlock_holmes.bundle


# unsafe

 33M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/extensions/x86_64-darwin-22/3.0.0-static/charlock_holmes-0.7.7/charlock_holmes/charlock_holmes.bundle

# safe to delete the version of ruby that isn't for the packed version

ie for 3.0.6, deleting everything bar /3.0/nokogiri.bundle is ok

2.9M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/nokogiri-1.15.2-x86_64-darwin/lib/nokogiri/3.2/nokogiri.bundle
2.9M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/nokogiri-1.15.2-x86_64-darwin/lib/nokogiri/3.1/nokogiri.bundle
2.9M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/nokogiri-1.15.2-x86_64-darwin/lib/nokogiri/3.0/nokogiri.bundle
2.9M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/nokogiri-1.15.2-x86_64-darwin/lib/nokogiri/2.7/nokogiri.bundle
2.5M    output/3.0.6-x86_64/lib/libcrypto.1.1.dylib
1.7M    output/3.0.6-x86_64/lib/ruby/gems/3.0.0/gems/sqlite3-1.6.3-x86_64-darwin/lib/sqlite3/3.2/sqlite3_native.bundle